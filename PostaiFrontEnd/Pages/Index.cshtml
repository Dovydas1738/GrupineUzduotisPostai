@page
@using GrupineUzduotisPostai.Core.Models
@using GrupineUzduotisPostai.Core.Services
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

<div class="text-center">
    <h2 class="display-4">Welcome to our Post Service! </h2>
    <p>We hope that ypu will enjoy our services.</p>
</div>



<h4 class="text-center">Posts:</h4>
<br>

<table class="my-table">
    <colgroup>
        <col span="1" style="background-color: #a2baee">
    </colgroup>
    <tr class="my-table-row-headings">
        <th class="my-table-column">ID</th>
        <th>UserID</th>
        <th>User name</th>
        <th>Name</th>
        <th>Content</th>
        <th>Date</th>
    </tr>
    @foreach (Post po in Model.Posts)
    {
        <tr class="my-table-row">
            <td class="my-table-column">@po.Id</td>
            <td>@po.User.UserId</td>
            <td>@po.User.UserName</td>
            <td>
                <a href="#" class="post-title" data-name="@po.Name">@po.Name</a>
            </td>
            <td class="my-content-limit">@po.Content</td>
            <td>@po.Date </td>
        </tr>
    }
</table>

<br>
<br>

<h4 class="text-center">Create new POST:</h4>
<br>
<form id="postCreateForm" class="text-center">

    <label for="userName">Enter Your Name:</label><br>
    <input type="text" id="userName" name="userName" required><br><br>

    <label for="name">Enter a name for your post:</label><br>
    <input type="text" id="name" name="name" required><br><br>
    
    <label for="content">Enter content for your post:</label><br>
    <input type="text" id="content" name="content" required><br><br>

    <button type="submit" id="submit-button">Submit</button>
</form>


<script>
    function sendFormDataAdd(endpoint, formData) {
        const plainFormData = Object.fromEntries(formData.entries());
        const jsonString = JSON.stringify(plainFormData);
        var submitButton = document.getElementById('submit-button');
        submitButton.innerText = 'Post is being created';
        submitButton.style.background = '#3CD5EF';
        fetch(endpoint, {
            method: 'POST',
            body: jsonString,
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                alert('Post has been added');
                window.location.href = '/Index'
            })
            .then(data => {
                console.log('Success:', data);
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
    }

    document.getElementById('postCreateForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const endpoint = 'https://localhost:7075/Posts/AddPost';
        const formData = new FormData(this);
        sendFormDataAdd(endpoint, formData);
    });
</script>

<br>
<br>


<div id="postDetails" style="display: none; padding: 15px; border: 1px solid #ddd;">
    <h4 id="postTitle"></h4>
    <p id="postContent"></p>
    <p id="postDate"></p>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.post-title').forEach(function (element) {
            element.addEventListener('click', function (e) {
                e.preventDefault();
                var postName = this.getAttribute('data-name');
                fetchPostDetails(postName);
            });
        });
    });

    function fetchPostDetails(postName) {
        fetch(`/Posts/GetPostByName?postName=${encodeURIComponent(postName)}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('postTitle').textContent = data.name;
                document.getElementById('postContent').textContent = data.content;
                document.getElementById('postDate').textContent = `Posted by ${data.userName} on ${new Date(data.date).toLocaleDateString()}`;
                document.getElementById('postDetails').style.display = 'block';
            })
            .catch(error => console.error('Error fetching post details:', error));
    }
</script>
