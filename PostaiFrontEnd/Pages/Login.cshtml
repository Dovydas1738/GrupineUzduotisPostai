@page
@using GrupineUzduotisPostai.Core.Models
@using GrupineUzduotisPostai.Core.Services
@model PostaiFrontEnd.Pages.LoginModel
@{
	ViewData["Title"] = "Login";
}


<div class="text-center">
    <h2 class="display-4">Login</h2>
    <p>Enter your user name to see your posts.</p>
</div>


<br>
<br>
<br>

<form id="loginForm" class="text-center">
    <label for="userName">Enter Your User Name:</label><br>
    <input type="text" id="userName" name="userName" required><br><br>
    <button type="submit" id="submit-button">Login</button>
</form>

<div id="postContainer" style="margin-top: 20px;"></div>


<script>
    document.getElementById('loginForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const userName = document.getElementById('userName').value;
        if (userName.trim() === '') {
            alert('Please enter a username.');
            return;
        }
        const endpoint = `https://localhost:7075/Posts/GetPostsByUserName?userName=${encodeURIComponent(userName)}`;
        fetch(endpoint, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }
                return response.json();
            })
            .then(posts => {
                displayPosts(posts);
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
                alert('Error fetching posts: ' + error.message);
            });
    });

    function displayPosts(posts) {
        const postContainer = document.getElementById('postContainer');
        postContainer.innerHTML = '';
        if (posts.length === 0) {
            postContainer.innerHTML = '<p>No posts found for the specified user.</p>';
            return;
        }
        posts.forEach(post => {
            const postElement = document.createElement('div');
            postElement.classList.add('post');
            postElement.style.border = '1px solid #ddd';
            postElement.style.padding = '10px';
            postElement.style.margin = '10px 0';

            const postTitle = document.createElement('h4');
            postTitle.textContent = post.name;

            const postContent = document.createElement('p');
            postContent.textContent = post.content;

            const postDate = document.createElement('p');
            postDate.textContent = `Posted by ${post.user.userName} on ${new Date(post.date).toLocaleDateString()}`;

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.style.marginTop = '10px';
            deleteButton.addEventListener('click', function () {
                deletePost(post.id);
                deleteButton.innerText = 'Post is being deleted';
                deleteButton.style.background = '#3CD5EF';
            });

            postElement.appendChild(postTitle);
            postElement.appendChild(postContent);
            postElement.appendChild(postDate);
            postElement.appendChild(deleteButton);
            postContainer.appendChild(postElement);
        });
    }

    function deletePost(postId) {
        const endpoint = `https://localhost:7075/Posts/DeletePost/${postId}`;

        fetch(endpoint, {
            method: 'DELETE',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                alert('Post has been deleted');
                window.location.href = '/Login'
                return response.json();
                
            })
            .then(data => {
                console.log('Success:', data);
                alert('Post has been deleted');
                window.location.reload(); 
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
    }
    
</script>